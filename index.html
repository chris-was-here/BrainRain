<!-- State of the Art
    * Willkommen im Spiel 'Bildungsziel'
    * Lass hirn regnen wo Hirn mangelt!
    
-->


<!-- TODO:

* Dartflug macht keinen sinn, sollte halbwegs verständlich sein
* BullsEye (targe.x, target.y ...) mit Stirn ableichen
* Augen als eigene png ausschneiden, viel weißer hintergrund
* Augen bewegen sich dem Dart nach
* Mund animieren
* Bulls Eye Treffer animieren
* Reset Button
* . . . .

-->

<!DOCTYPE html>
<html>

<body
    style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0;">
    <h1>Lass Hirn regnen!</h1>
    <canvas id="gameCanvas"></canvas>
    <button id="resetButton">Reset Game</button>
    <script>
        let canvas = document.getElementById('gameCanvas');
        let resetButton = document.getElementById('resetButton');
        canvas.width = window.innerWidth * 0.8;
        canvas.height = window.innerHeight * 0.8;

        let ctx = canvas.getContext('2d');

        let dart = { x: 0, y: 0, vx: 0, vy: 0, state: 'idle', size: 50 };
        let target = {
            x: canvas.width / 2 - canvas.width * 0.125 - 120,
            y: canvas.height / 2 - canvas.height * 0.15 - 115,
            width: canvas.width * 0.25,
            height: canvas.height * 0.15
        };

        let targetImage = new Image();
        targetImage.src = 'kickl.png';

        let dartImage = new Image();
        dartImage.src = 'hirn.png';

        let shotCount = 0;
        let hitDarts = [];

        let flashCount = 0;
        let flashFlag = false;

        resetButton.addEventListener('click', () => {
            // Reset the game
            dart = { x: 0, y: 0, vx: 0, vy: 0, state: 'idle', size: 50 };
            target = { x: canvas.width / 2 - canvas.width * 0.125, y: canvas.height / 2 - canvas.height * 0.15, width: canvas.width * 0.25, height: canvas.height * 0.2 };
            shotCount = 0;
            hitDarts = [];
            flashCount = 0;
            flashFlag = false;
        });

        canvas.addEventListener('mousedown', (e) => {
            if (dart.state === 'idle' && shotCount < 3) {
                dart.x = e.clientX;
                dart.y = e.clientY;
                dart.state = 'aiming';
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (dart.state === 'aiming') {
                dart.vx = (dart.x - e.clientX) * 0.03;
                dart.vy = (dart.y - e.clientY) * 0.03;
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (dart.state === 'aiming') {
                dart.state = 'flying';
                shotCount++;
            }
        });

        function drawArrow(fromx, fromy, tox, toy) {
            let headlen = 10;
            let dx = tox - fromx;
            let dy = toy - fromy;
            let angle = Math.atan2(dy, dx);
            ctx.moveTo(fromx, fromy);
            ctx.lineTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
        }

        function resetGame() {
            dart = { x: 0, y: 0, vx: 0, vy: 0, state: 'idle', size: 50 };
            shotCount = 0;
            hitDarts = [];
            flashCount = 0;
            flashFlag = false;
        }

        function gameLoop() {
            if (dart.state === 'flying') {
                dart.x += dart.vx;
                dart.y += dart.vy;

                // Increase the size of the dart as it flies
                dart.size += 1;
                if (dart.size > 150) dart.size = 150;

                // Check if the dart is outside the canvas
                if (dart.x < 0 || dart.y < 0 || dart.x > canvas.width || dart.y > canvas.height) {
                    dart.state = 'idle';
                    dart.x = 0;
                    dart.y = 0;
                    dart.size = 50;
                } else {
                    // Check if the dart hits the target
                    if (dart.x > target.x && dart.x < target.x + target.width && dart.y > target.y && dart.y < target.y + target.height) {
                        dart.state = 'hit';
                        hitDarts.push({ x: dart.x, y: dart.y, size: dart.size });
                        dart.size = 50;
                        flashCount = 6;
                        flashFlag = true;
                        alert('passt aber nicht');
                        resetGame();
                    }
                }
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (flashFlag && flashCount > 0) {
                ctx.fillStyle = flashCount % 2 === 0 ? 'pink' : 'transparent';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                flashCount--;
                if (flashCount === 0) flashFlag = false;
            } else {
                ctx.drawImage(targetImage, 0, 0, canvas.width, canvas.height);
            }

            hitDarts.forEach(d => ctx.drawImage(dartImage, d.x - d.size / 2, d.y - d.size / 2, d.size, d.size));
            if (dart.state !== 'hit') ctx.drawImage(dartImage, dart.x - dart.size / 2, dart.y - dart.size / 2, dart.size, dart.size);

            // Draw the target rectangle with a green border
            ctx.strokeStyle = 'green';
            ctx.strokeRect(target.x, target.y, target.width, target.height);

            ctx.beginPath();
            ctx.strokeStyle = 'red'; // Set the color of the arrow to red
            drawArrow(canvas.width / 2, canvas.height / 2, dart.x, dart.y);
            ctx.stroke();

            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>

</html>